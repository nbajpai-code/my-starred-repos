name: Setup arXiv Paper Trackers

on:
  workflow_dispatch:
    inputs:
      tracker_type:
        description: 'Which arXiv tracker to set up'
        required: true
        type: choice
        options:
          - daily-arXiv-ai-enhanced
          - ArxivDigest
          - DailyArXiv
          - awesome-daily-AI-arxiv
          - cv-arxiv-daily

      keywords:
        description: 'Research keywords (comma-separated)'
        required: true
        default: 'large language model, reinforcement learning, transformers'
        type: string

      categories:
        description: 'arXiv categories (comma-separated)'
        required: true
        default: 'cs.AI, cs.LG, cs.CL'
        type: string

      enable_notifications:
        description: 'Enable GitHub Issues for new papers'
        required: false
        default: true
        type: boolean

      auto_star_papers:
        description: 'Automatically star highly relevant papers'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  issues: write
  actions: write

jobs:
  setup-tracker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          gh auth status

      - name: Fork and setup tracker
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Map tracker choice to repo
          case "${{ github.event.inputs.tracker_type }}" in
            "daily-arXiv-ai-enhanced")
              REPO="dw-dengwei/daily-arXiv-ai-enhanced"
              CONFIG_FILE="arxiv-config.yml"
              ;;
            "ArxivDigest")
              REPO="AutoLLM/ArxivDigest"
              CONFIG_FILE="config.yaml"
              ;;
            "DailyArXiv")
              REPO="MLNLP-World/DailyArXiv"
              CONFIG_FILE="config.yaml"
              ;;
            "awesome-daily-AI-arxiv")
              REPO="MLNLP-World/awesome-daily-AI-arxiv"
              CONFIG_FILE="config.yaml"
              ;;
            "cv-arxiv-daily")
              REPO="Vincentqyw/cv-arxiv-daily"
              CONFIG_FILE="config.yaml"
              ;;
          esac

          echo "REPO=$REPO" >> $GITHUB_ENV
          echo "CONFIG_FILE=$CONFIG_FILE" >> $GITHUB_ENV
          echo "REPO_NAME=$(basename $REPO)" >> $GITHUB_ENV

          # Check if already forked
          USER=$(gh api user -q .login)
          echo "USER=$USER" >> $GITHUB_ENV

          if gh repo view "$USER/$(basename $REPO)" &>/dev/null; then
            echo "âœ“ Repository already forked: $USER/$(basename $REPO)"
          else
            echo "Forking $REPO..."
            gh repo fork "$REPO" --clone=false
            echo "âœ“ Repository forked successfully"
          fi

      - name: Clone and configure tracker
        run: |
          # Clone the forked repo
          if [ -d "$REPO_NAME" ]; then
            cd "$REPO_NAME"
            git pull
          else
            gh repo clone "$USER/$REPO_NAME"
            cd "$REPO_NAME"
          fi

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create/update configuration
          cat > "$CONFIG_FILE" << 'EOF'
          # Auto-generated arXiv tracker configuration
          # Generated by: ${{ github.workflow }}
          # Date: $(date +'%Y-%m-%d %H:%M:%S UTC')

          keywords:
          EOF

          # Add keywords
          IFS=',' read -ra KEYWORDS <<< "${{ github.event.inputs.keywords }}"
          for keyword in "${KEYWORDS[@]}"; do
            keyword=$(echo "$keyword" | xargs)  # trim whitespace
            echo "  - \"$keyword\"" >> "$CONFIG_FILE"
          done

          # Add categories
          echo "" >> "$CONFIG_FILE"
          echo "categories:" >> "$CONFIG_FILE"
          IFS=',' read -ra CATEGORIES <<< "${{ github.event.inputs.categories }}"
          for category in "${CATEGORIES[@]}"; do
            category=$(echo "$category" | xargs)  # trim whitespace
            echo "  - \"$category\"" >> "$CONFIG_FILE"
          done

          # Add additional config based on tracker type
          case "${{ github.event.inputs.tracker_type }}" in
            "DailyArXiv")
              cat >> "$CONFIG_FILE" << 'CONFIGEOF'

          max_papers_per_keyword: 100

          notifications:
            github_issues: ${{ github.event.inputs.enable_notifications }}
            email: false

          update_schedule: "daily"
          CONFIGEOF
              ;;
            "daily-arXiv-ai-enhanced")
              cat >> "$CONFIG_FILE" << 'CONFIGEOF'

          ai_summary: true
          max_papers: 50
          github_issues: ${{ github.event.inputs.enable_notifications }}
          CONFIGEOF
              ;;
          esac

          echo "âœ“ Configuration file created: $CONFIG_FILE"
          cat "$CONFIG_FILE"

          # Commit configuration
          git add "$CONFIG_FILE"
          git commit -m "Configure arXiv tracking - automated via GitHub Actions

          Keywords: ${{ github.event.inputs.keywords }}
          Categories: ${{ github.event.inputs.categories }}

          ðŸ¤– Generated with GitHub Actions" || echo "No changes to commit"

          # Push changes
          git push || echo "Already up to date"

      - name: Enable GitHub Actions on forked repo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Enabling GitHub Actions for $USER/$REPO_NAME..."

          gh api \
            --method PUT \
            -H "Accept: application/vnd.github+json" \
            "/repos/$USER/$REPO_NAME/actions/permissions" \
            -f enabled=true \
            -f allowed_actions=all 2>/dev/null || echo "Actions may already be enabled"

          echo "âœ“ GitHub Actions enabled"

      - name: Set up repository watch
        if: github.event.inputs.enable_notifications == 'true'
        run: |
          echo "Setting up notifications for $USER/$REPO_NAME..."
          gh repo watch "$USER/$REPO_NAME" --watch || echo "Already watching"
          echo "âœ“ Repository watch enabled"

      - name: Create tracking issue
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const trackerName = '${{ github.event.inputs.tracker_type }}';
            const repoUrl = `https://github.com/${{ env.USER }}/${{ env.REPO_NAME }}`;

            const body = `# ðŸŽ‰ arXiv Tracker Setup Complete!

            ## ðŸ“Š Configuration Summary

            **Tracker:** ${trackerName}
            **Repository:** [${repoUrl}](${repoUrl})
            **Setup Date:** ${date}

            ### ðŸ” Research Focus

            **Keywords:**
            \`\`\`
            ${{ github.event.inputs.keywords }}
            \`\`\`

            **arXiv Categories:**
            \`\`\`
            ${{ github.event.inputs.categories }}
            \`\`\`

            ### âš™ï¸ Settings

            - **Notifications:** ${{ github.event.inputs.enable_notifications && 'âœ… Enabled' || 'âŒ Disabled' }}
            - **Auto-star papers:** ${{ github.event.inputs.auto_star_papers && 'âœ… Enabled' || 'âŒ Disabled' }}
            - **Update frequency:** Daily (automated via GitHub Actions)

            ## ðŸš€ What's Next?

            1. **View Papers:** [${repoUrl}](${repoUrl})
            2. **Check Workflows:** [${repoUrl}/actions](${repoUrl}/actions)
            3. **Customize Config:** Edit the config file in your forked repo
            4. **Watch for Updates:** Papers will be tracked daily

            ## ðŸ”— Quick Links

            - [Repository](${repoUrl})
            - [Actions](${repoUrl}/actions)
            - [Issues](${repoUrl}/issues)
            - [Configuration Guide](https://github.com/${{ github.repository }}/blob/master/scripts/arxiv-automation/README.md)

            ## ðŸ“ Modifying Your Tracker

            To update keywords or categories:
            1. Go to your forked repository: ${repoUrl}
            2. Edit the config file
            3. Commit changes
            4. Next run will use updated configuration

            ## ðŸ†˜ Need Help?

            - Check the [Automation Guide](https://github.com/${{ github.repository }}/blob/master/scripts/arxiv-automation/README.md)
            - View [arXiv Research Guide](https://github.com/${{ github.repository }}/blob/master/ARXIV_RESEARCH_GUIDE.md)
            - Open an issue in this repository

            ---

            *ðŸ¤– Automated setup via GitHub Actions*
            *Workflow: ${{ github.workflow }}*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“š arXiv Tracker Set Up: ${trackerName} - ${date}`,
              body: body,
              labels: ['arxiv-tracker', 'automated', 'setup-complete']
            });

      - name: Update tracking registry
        run: |
          # Create/update a registry of active trackers
          mkdir -p arxiv-trackers

          cat > "arxiv-trackers/${{ github.event.inputs.tracker_type }}.md" << EOF
          # ${{ github.event.inputs.tracker_type }}

          **Status:** âœ… Active
          **Repository:** https://github.com/$USER/$REPO_NAME
          **Setup Date:** $(date +'%Y-%m-%d')
          **Last Updated:** $(date +'%Y-%m-%d %H:%M:%S UTC')

          ## Configuration

          **Keywords:**
          ${{ github.event.inputs.keywords }}

          **Categories:**
          ${{ github.event.inputs.categories }}

          **Notifications:** ${{ github.event.inputs.enable_notifications }}

          ## Links

          - [View Papers](https://github.com/$USER/$REPO_NAME)
          - [Workflow Runs](https://github.com/$USER/$REPO_NAME/actions)
          - [Issues](https://github.com/$USER/$REPO_NAME/issues)

          ---

          *Last sync: $(date +'%Y-%m-%d %H:%M:%S UTC')*
          EOF

          # Update main index
          if [ ! -f "arxiv-trackers/README.md" ]; then
            cat > "arxiv-trackers/README.md" << EOF
          # Active arXiv Paper Trackers

          This directory tracks all active arXiv paper trackers set up via automation.

          ## Active Trackers

          EOF
          fi

          # Add to index if not already there
          if ! grep -q "${{ github.event.inputs.tracker_type }}" "arxiv-trackers/README.md"; then
            echo "- [${{ github.event.inputs.tracker_type }}](${{ github.event.inputs.tracker_type }}.md) - Set up on $(date +'%Y-%m-%d')" >> "arxiv-trackers/README.md"
          fi

          git add arxiv-trackers/
          git commit -m "ðŸ“Š Track arXiv tracker: ${{ github.event.inputs.tracker_type }}

          Added tracking registry for ${{ github.event.inputs.tracker_type }}

          ðŸ¤– Generated with GitHub Actions" || echo "No changes to commit"

          git push || echo "Already up to date"

      - name: Summary
        run: |
          echo "========================================" >> $GITHUB_STEP_SUMMARY
          echo "# ðŸŽ‰ arXiv Tracker Setup Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tracker:** ${{ github.event.inputs.tracker_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** https://github.com/$USER/$REPO_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **Keywords:** ${{ github.event.inputs.keywords }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Categories:** ${{ github.event.inputs.categories }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [View Papers](https://github.com/$USER/$REPO_NAME)" >> $GITHUB_STEP_SUMMARY
          echo "- [Workflow Runs](https://github.com/$USER/$REPO_NAME/actions)" >> $GITHUB_STEP_SUMMARY
          echo "- [Configure](https://github.com/$USER/$REPO_NAME/blob/main/$CONFIG_FILE)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Papers will be tracked daily automatically" >> $GITHUB_STEP_SUMMARY
          echo "2. Check the Actions tab in your forked repo" >> $GITHUB_STEP_SUMMARY
          echo "3. Review papers as they're discovered" >> $GITHUB_STEP_SUMMARY
          echo "4. Customize config file as needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*ðŸ¤– Automated via GitHub Actions*" >> $GITHUB_STEP_SUMMARY
