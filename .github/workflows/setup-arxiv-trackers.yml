name: Setup arXiv Paper Trackers

on:
  workflow_dispatch:
    inputs:
      tracker_type:
        description: 'Which arXiv tracker to set up'
        required: true
        type: choice
        options:
          - daily-arXiv-ai-enhanced
          - ArxivDigest
          - DailyArXiv
          - awesome-daily-AI-arxiv
          - cv-arxiv-daily

      keywords:
        description: 'Research keywords (comma-separated)'
        required: true
        default: 'large language model, reinforcement learning, transformers'
        type: string

      categories:
        description: 'arXiv categories (comma-separated)'
        required: true
        default: 'cs.AI, cs.LG, cs.CL'
        type: string

      enable_notifications:
        description: 'Enable GitHub Issues for new papers'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  issues: write

jobs:
  create-setup-guide:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate configuration files
        id: config
        run: |
          # Map tracker choice to repo
          case "${{ github.event.inputs.tracker_type }}" in
            "daily-arXiv-ai-enhanced")
              REPO="dw-dengwei/daily-arXiv-ai-enhanced"
              CONFIG_FILE="arxiv-config.yml"
              ;;
            "ArxivDigest")
              REPO="AutoLLM/ArxivDigest"
              CONFIG_FILE="config.yaml"
              ;;
            "DailyArXiv")
              REPO="MLNLP-World/DailyArXiv"
              CONFIG_FILE="config.yaml"
              ;;
            "awesome-daily-AI-arxiv")
              REPO="MLNLP-World/awesome-daily-AI-arxiv"
              CONFIG_FILE="config.yaml"
              ;;
            "cv-arxiv-daily")
              REPO="Vincentqyw/cv-arxiv-daily"
              CONFIG_FILE="config.yaml"
              ;;
          esac

          echo "REPO=$REPO" >> $GITHUB_OUTPUT
          echo "CONFIG_FILE=$CONFIG_FILE" >> $GITHUB_OUTPUT
          echo "REPO_NAME=$(basename $REPO)" >> $GITHUB_OUTPUT

          # Create config directory
          mkdir -p arxiv-tracker-configs

          # Generate configuration file
          cat > "arxiv-tracker-configs/${{ github.event.inputs.tracker_type }}-config.yaml" << 'EOF'
          # arXiv Tracker Configuration
          # Generated for: ${{ github.event.inputs.tracker_type }}
          # Date: $(date +'%Y-%m-%d')

          keywords:
          EOF

          # Add keywords
          IFS=',' read -ra KEYWORDS <<< "${{ github.event.inputs.keywords }}"
          for keyword in "${KEYWORDS[@]}"; do
            keyword=$(echo "$keyword" | xargs)  # trim whitespace
            echo "  - \"$keyword\"" >> "arxiv-tracker-configs/${{ github.event.inputs.tracker_type }}-config.yaml"
          done

          # Add categories
          echo "" >> "arxiv-tracker-configs/${{ github.event.inputs.tracker_type }}-config.yaml"
          echo "categories:" >> "arxiv-tracker-configs/${{ github.event.inputs.tracker_type }}-config.yaml"
          IFS=',' read -ra CATEGORIES <<< "${{ github.event.inputs.categories }}"
          for category in "${CATEGORIES[@]}"; do
            category=$(echo "$category" | xargs)  # trim whitespace
            echo "  - \"$category\"" >> "arxiv-tracker-configs/${{ github.event.inputs.tracker_type }}-config.yaml"
          done

          # Add notifications setting
          cat >> "arxiv-tracker-configs/${{ github.event.inputs.tracker_type }}-config.yaml" << 'CONFIGEOF'

          # Notification settings
          notifications:
            github_issues: ${{ github.event.inputs.enable_notifications }}
            email: false

          # Update schedule
          update_schedule: "daily"
          CONFIGEOF

      - name: Create setup guide issue
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const trackerType = '${{ github.event.inputs.tracker_type }}';
            const repo = '${{ steps.config.outputs.REPO }}';
            const repoName = '${{ steps.config.outputs.REPO_NAME }}';
            const configFile = '${{ steps.config.outputs.CONFIG_FILE }}';

            const body = `# ðŸš€ arXiv Tracker Setup Guide

            Your tracker configuration is ready! Follow these simple steps to complete the setup.

            ## ðŸ“Š Your Configuration

            **Tracker:** ${trackerType}
            **Source Repository:** [${repo}](https://github.com/${repo})
            **Date:** ${date}

            ### ðŸ” Research Focus

            **Keywords:**
            \`\`\`
            ${{ github.event.inputs.keywords }}
            \`\`\`

            **arXiv Categories:**
            \`\`\`
            ${{ github.event.inputs.categories }}
            \`\`\`

            **Notifications:** ${{ github.event.inputs.enable_notifications && 'âœ… Enabled' || 'âŒ Disabled' }}

            ---

            ## ðŸŽ¯ Setup Steps (2-3 minutes)

            ### Step 1: Fork the Repository

            Click this button to fork the tracker repository:

            **ðŸ‘‰ [Fork ${repoName}](https://github.com/${repo}/fork)**

            Or use GitHub CLI:
            \`\`\`bash
            gh repo fork ${repo} --clone=false
            \`\`\`

            ### Step 2: Clone Your Fork

            \`\`\`bash
            gh repo clone YOUR_USERNAME/${repoName}
            cd ${repoName}
            \`\`\`

            ### Step 3: Add Configuration

            Download your pre-generated config:

            **ðŸ‘‰ [Download Config](https://github.com/${{ github.repository }}/blob/master/arxiv-tracker-configs/${trackerType}-config.yaml)**

            Save it as \`${configFile}\` in your forked repository.

            Or create it manually:

            \`\`\`yaml
            keywords:
            $(echo '${{ github.event.inputs.keywords }}' | sed 's/,/\\n  - "/g' | sed 's/^/  - "/' | sed 's/$/"/')

            categories:
            $(echo '${{ github.event.inputs.categories }}' | sed 's/,/\\n  - "/g' | sed 's/^/  - "/' | sed 's/$/"/')

            notifications:
              github_issues: ${{ github.event.inputs.enable_notifications }}
              email: false

            update_schedule: "daily"
            \`\`\`

            ### Step 4: Commit and Push

            \`\`\`bash
            git add ${configFile}
            git commit -m "Configure arXiv tracking for my research interests"
            git push
            \`\`\`

            ### Step 5: Enable GitHub Actions

            1. Go to your forked repo: \`https://github.com/YOUR_USERNAME/${repoName}\`
            2. Click the **Actions** tab
            3. Click **"I understand my workflows, go ahead and enable them"**
            4. Done! Papers will be tracked daily automatically

            ---

            ## ðŸ”„ Alternative: Use Our CLI Script

            For automated setup without manual steps:

            \`\`\`bash
            cd scripts/arxiv-automation
            ./setup-arxiv-tracker.sh
            \`\`\`

            Select option **${trackerType.split('-')[0] === 'daily' ? '1' : trackerType === 'ArxivDigest' ? '2' : trackerType === 'DailyArXiv' ? '3' : trackerType === 'awesome' ? '4' : '5'}** when prompted.

            ---

            ## âœ… What Happens Next?

            Once set up:

            1. **Daily at 9 AM UTC:** Your tracker runs automatically
            2. **Papers matching your keywords** are fetched from arXiv
            3. **Summaries are generated** (if enabled)
            4. **GitHub Issues created** with new papers (if enabled)
            5. **You review papers** in your forked repository

            ## ðŸ”— Quick Links

            - [Fork Repository](https://github.com/${repo}/fork)
            - [Your Config File](https://github.com/${{ github.repository }}/blob/master/arxiv-tracker-configs/${trackerType}-config.yaml)
            - [CLI Setup Script](https://github.com/${{ github.repository }}/blob/master/scripts/arxiv-automation/setup-arxiv-tracker.sh)
            - [Full Documentation](https://github.com/${{ github.repository }}/blob/master/.github/workflows/ARXIV_WORKFLOWS.md)

            ## ðŸ†˜ Need Help?

            - Check the [Automation Guide](https://github.com/${{ github.repository }}/blob/master/scripts/arxiv-automation/README.md)
            - View [arXiv Research Guide](https://github.com/${{ github.repository }}/blob/master/ARXIV_RESEARCH_GUIDE.md)
            - Comment on this issue with questions

            ---

            **ðŸ“Œ Once you've completed setup, close this issue and your tracker will run automatically!**

            *ðŸ¤– Generated via GitHub Actions*
            *Workflow: Setup arXiv Paper Trackers*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš€ Setup Guide: ${trackerType} - ${date}`,
              body: body,
              labels: ['arxiv-tracker', 'setup-guide', 'help-wanted']
            });

      - name: Save configuration
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add arxiv-tracker-configs/
          git commit -m "ðŸ“ Generated config for ${{ github.event.inputs.tracker_type }}

          Configuration for arXiv tracker setup:
          - Tracker: ${{ github.event.inputs.tracker_type }}
          - Keywords: ${{ github.event.inputs.keywords }}
          - Categories: ${{ github.event.inputs.categories }}

          ðŸ¤– Generated with GitHub Actions" || echo "No changes to commit"

          git push || echo "Already up to date"

      - name: Summary
        run: |
          echo "# ðŸŽ‰ Configuration Generated!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Tracker Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tracker:** ${{ github.event.inputs.tracker_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** [${{ steps.config.outputs.REPO }}](https://github.com/${{ steps.config.outputs.REPO }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Keywords:** \`${{ github.event.inputs.keywords }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Categories:** \`${{ github.event.inputs.categories }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Check Issues tab** for your personalized setup guide" >> $GITHUB_STEP_SUMMARY
          echo "2. **Fork the repository:** [Click here](https://github.com/${{ steps.config.outputs.REPO }}/fork)" >> $GITHUB_STEP_SUMMARY
          echo "3. **Download config:** [Config file](https://github.com/${{ github.repository }}/blob/master/arxiv-tracker-configs/${{ github.event.inputs.tracker_type }}-config.yaml)" >> $GITHUB_STEP_SUMMARY
          echo "4. **Follow the guide** in the newly created issue" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*ðŸ¤– Configuration saved to \`arxiv-tracker-configs/\` directory*" >> $GITHUB_STEP_SUMMARY
