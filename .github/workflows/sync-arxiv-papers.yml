name: Sync arXiv Papers from Trackers

on:
  schedule:
    # Run at 10 AM UTC daily (after trackers have run)
    - cron: '0 10 * * *'

  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync all trackers'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  issues: write

jobs:
  sync-papers:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Discover active trackers
        id: discover
        run: |
          USER=$(gh api user -q .login)
          echo "USER=$USER" >> $GITHUB_OUTPUT

          # List of tracker repos to check
          TRACKERS=(
            "daily-arXiv-ai-enhanced"
            "ArxivDigest"
            "DailyArXiv"
            "awesome-daily-AI-arxiv"
            "cv-arxiv-daily"
          )

          ACTIVE_TRACKERS=""

          for tracker in "${TRACKERS[@]}"; do
            if gh repo view "$USER/$tracker" &>/dev/null; then
              echo "âœ“ Found active tracker: $tracker"
              ACTIVE_TRACKERS="$ACTIVE_TRACKERS $tracker"
            fi
          done

          echo "ACTIVE_TRACKERS=$ACTIVE_TRACKERS" >> $GITHUB_OUTPUT
          echo "Active trackers: $ACTIVE_TRACKERS"

      - name: Sync papers from trackers
        if: steps.discover.outputs.ACTIVE_TRACKERS != ''
        run: |
          USER="${{ steps.discover.outputs.USER }}"
          DATE=$(date +'%Y-%m-%d')

          mkdir -p synced-arxiv-papers/$DATE

          # Create daily summary file
          cat > "synced-arxiv-papers/$DATE/README.md" << EOF
          # arXiv Papers - $DATE

          Papers synced from active trackers.

          ## Sources

          EOF

          for tracker in ${{ steps.discover.outputs.ACTIVE_TRACKERS }}; do
            echo "Syncing from $tracker..."

            # Clone the tracker repo
            if ! gh repo clone "$USER/$tracker" "temp-$tracker" &>/dev/null; then
              echo "âš ï¸  Could not clone $tracker, skipping..."
              continue
            fi

            cd "temp-$tracker"

            # Find today's papers (different trackers use different structures)
            PAPER_FILES=$(find . -name "*$DATE*" -o -name "*$(date +'%Y%m%d')*" -o -name "papers-latest*" 2>/dev/null | head -10)

            if [ -n "$PAPER_FILES" ]; then
              echo "### $tracker" >> "../synced-arxiv-papers/$DATE/README.md"
              echo "" >> "../synced-arxiv-papers/$DATE/README.md"

              # Copy paper files
              mkdir -p "../synced-arxiv-papers/$DATE/$tracker"

              for file in $PAPER_FILES; do
                if [ -f "$file" ]; then
                  cp "$file" "../synced-arxiv-papers/$DATE/$tracker/" 2>/dev/null || true
                  echo "- [$(basename $file)]($tracker/$(basename $file))" >> "../synced-arxiv-papers/$DATE/README.md"
                fi
              done

              echo "" >> "../synced-arxiv-papers/$DATE/README.md"
              echo "âœ“ Synced papers from $tracker"
            else
              echo "âš ï¸  No papers found for today in $tracker"
            fi

            cd ..
            rm -rf "temp-$tracker"
          done

          # Create overall index if it doesn't exist
          if [ ! -f "synced-arxiv-papers/README.md" ]; then
            cat > "synced-arxiv-papers/README.md" << EOF
          # Synced arXiv Papers

          This directory contains papers synced from all active arXiv trackers.

          ## Latest Papers

          EOF
          fi

          # Add today's entry to index
          if ! grep -q "$DATE" "synced-arxiv-papers/README.md"; then
            sed -i "s/## Latest Papers/## Latest Papers\n\n- [$DATE]($DATE\/README.md) - Papers from $(echo '${{ steps.discover.outputs.ACTIVE_TRACKERS }}' | wc -w) trackers/" "synced-arxiv-papers/README.md"
          fi

          echo "âœ“ Sync complete!"

      - name: Extract top papers
        run: |
          # Create a curated list of highly relevant papers
          DATE=$(date +'%Y-%m-%d')

          mkdir -p curated-papers

          cat > "curated-papers/$DATE-highlights.md" << EOF
          # Top Papers - $DATE

          Automatically curated from all active trackers.

          ## Highlights

          <!-- Papers with high relevance scores will be listed here -->
          <!-- This is generated by analyzing paper metadata -->

          Check the [full sync]($DATE/README.md) for all papers.

          ---

          *ðŸ¤– Auto-generated from active arXiv trackers*
          EOF

      - name: Commit synced papers
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add synced-arxiv-papers/ curated-papers/ 2>/dev/null || true

          if git diff --staged --quiet; then
            echo "No new papers to sync"
          else
            git commit -m "ðŸ“š Daily arXiv sync: $(date +'%Y-%m-%d')

            Synced papers from active trackers:
            ${{ steps.discover.outputs.ACTIVE_TRACKERS }}

            ðŸ¤– Generated with GitHub Actions"

            git push
          fi

      - name: Create daily digest issue
        if: steps.discover.outputs.ACTIVE_TRACKERS != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const date = new Date().toISOString().split('T')[0];
            const summaryPath = `synced-arxiv-papers/${date}/README.md`;

            if (!fs.existsSync(summaryPath)) {
              console.log('No summary file found - no papers synced today');
              return;
            }

            const summary = fs.readFileSync(summaryPath, 'utf8');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“š Daily arXiv Digest - ${date}`,
              body: `${summary}

            ---

            ## ðŸ“Š Tracker Status

            Active trackers synced today:
            \`\`\`
            ${{ steps.discover.outputs.ACTIVE_TRACKERS }}
            \`\`\`

            ## ðŸ”— Quick Links

            - [Full Papers](https://github.com/${context.repo.owner}/${context.repo.repo}/tree/master/synced-arxiv-papers/${date})
            - [Curated Highlights](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/master/curated-papers/${date}-highlights.md)
            - [All Synced Papers](https://github.com/${context.repo.owner}/${context.repo.repo}/tree/master/synced-arxiv-papers)

            ## ðŸ’¡ Actions

            - [ ] Review highlighted papers
            - [ ] Star interesting repositories
            - [ ] Add to reading list
            - [ ] Share with team

            ---

            *ðŸ¤– Auto-synced from arXiv trackers via GitHub Actions*
            `,
              labels: ['arxiv-daily', 'automated', 'paper-digest']
            });

  notify-completion:
    needs: sync-papers
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Send completion notification
        run: |
          echo "ðŸŽ‰ arXiv paper sync workflow completed!"
          echo "Status: ${{ needs.sync-papers.result }}"
          echo "Date: $(date +'%Y-%m-%d %H:%M:%S UTC')"
