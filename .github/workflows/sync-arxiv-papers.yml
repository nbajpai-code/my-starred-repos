name: Sync arXiv Papers from Trackers

on:
  schedule:
    # Run at 10 AM UTC daily (after trackers have run)
    - cron: '0 10 * * *'

  workflow_dispatch:
    inputs:
      create_summary:
        description: 'Create summary issue'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  issues: write

jobs:
  sync-papers:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for tracker registry
        id: check
        run: |
          if [ -d "arxiv-tracker-configs" ] && [ "$(ls -A arxiv-tracker-configs/*.yaml 2>/dev/null)" ]; then
            echo "has_trackers=true" >> $GITHUB_OUTPUT
            echo "âœ“ Found tracker configurations"
            ls -la arxiv-tracker-configs/
          else
            echo "has_trackers=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No tracker configurations found yet"
            echo "Run the 'Setup arXiv Paper Trackers' workflow first to configure trackers"
          fi

      - name: Create sync summary
        if: steps.check.outputs.has_trackers == 'true'
        run: |
          DATE=$(date +'%Y-%m-%d')
          mkdir -p synced-arxiv-papers/$DATE

          # Create summary of configured trackers
          cat > "synced-arxiv-papers/$DATE/README.md" << EOF
          # arXiv Papers Sync - $DATE

          ## Configured Trackers

          EOF

          # List configured trackers
          for config_file in arxiv-tracker-configs/*.yaml; do
            if [ -f "$config_file" ]; then
              tracker_name=$(basename "$config_file" -config.yaml)
              echo "- **$tracker_name**" >> "synced-arxiv-papers/$DATE/README.md"

              # Extract keywords from config
              if grep -q "keywords:" "$config_file"; then
                echo "  - Keywords:" >> "synced-arxiv-papers/$DATE/README.md"
                grep -A 10 "keywords:" "$config_file" | grep "  - " | head -5 >> "synced-arxiv-papers/$DATE/README.md"
              fi
              echo "" >> "synced-arxiv-papers/$DATE/README.md"
            fi
          done

          cat >> "synced-arxiv-papers/$DATE/README.md" << EOF

          ## ðŸ“ Next Steps

          Once you've forked and set up your trackers (following the setup guide issues):
          1. Papers will be tracked in your forked repositories
          2. You can manually sync them here if needed
          3. Or use the CLI script: \`scripts/arxiv-automation/setup-arxiv-tracker.sh\`

          ## ðŸ”— Your Tracker Configurations

          EOF

          for config_file in arxiv-tracker-configs/*.yaml; do
            if [ -f "$config_file" ]; then
              tracker_name=$(basename "$config_file" -config.yaml)
              echo "- [$tracker_name](./$tracker_name-config.yaml)" >> "synced-arxiv-papers/$DATE/README.md"
            fi
          done

          # Create overall index
          if [ ! -f "synced-arxiv-papers/README.md" ]; then
            cat > "synced-arxiv-papers/README.md" << EOF
          # Synced arXiv Papers

          This directory tracks your arXiv paper tracker configurations and sync history.

          ## Latest Syncs

          EOF
          fi

          # Add today's entry to index
          if ! grep -q "$DATE" "synced-arxiv-papers/README.md" 2>/dev/null; then
            sed -i "s/## Latest Syncs/## Latest Syncs\n\n- [$DATE]($DATE\/README.md) - Tracker configuration summary/" "synced-arxiv-papers/README.md" || \
            echo "- [$DATE]($DATE/README.md) - Tracker configuration summary" >> "synced-arxiv-papers/README.md"
          fi

      - name: Update tracker status
        if: steps.check.outputs.has_trackers == 'true'
        run: |
          mkdir -p arxiv-trackers
          DATE=$(date +'%Y-%m-%d')

          # Create tracker status index
          cat > "arxiv-trackers/README.md" << EOF
          # Active arXiv Paper Trackers

          Status of your configured arXiv paper trackers.

          **Last Updated:** $DATE

          ## Configured Trackers

          EOF

          # List all configured trackers
          for config_file in arxiv-tracker-configs/*.yaml; do
            if [ -f "$config_file" ]; then
              tracker_name=$(basename "$config_file" -config.yaml)

              echo "### $tracker_name" >> "arxiv-trackers/README.md"
              echo "" >> "arxiv-trackers/README.md"
              echo "**Status:** âš™ï¸ Configured (awaiting fork setup)" >> "arxiv-trackers/README.md"
              echo "**Config:** [View Configuration](../arxiv-tracker-configs/$tracker_name-config.yaml)" >> "arxiv-trackers/README.md"
              echo "" >> "arxiv-trackers/README.md"

              # Show keywords
              echo "**Keywords:**" >> "arxiv-trackers/README.md"
              grep -A 10 "keywords:" "$config_file" | grep "  - " | head -5 | sed 's/^/- /' >> "arxiv-trackers/README.md"
              echo "" >> "arxiv-trackers/README.md"

              # Show categories
              echo "**Categories:**" >> "arxiv-trackers/README.md"
              grep -A 5 "categories:" "$config_file" | grep "  - " | sed 's/^/- /' >> "arxiv-trackers/README.md"
              echo "" >> "arxiv-trackers/README.md"

              echo "**Next Steps:**" >> "arxiv-trackers/README.md"
              echo "1. Check Issues tab for setup guide" >> "arxiv-trackers/README.md"
              echo "2. Fork the tracker repository" >> "arxiv-trackers/README.md"
              echo "3. Add configuration and enable Actions" >> "arxiv-trackers/README.md"
              echo "4. Papers will be tracked daily automatically" >> "arxiv-trackers/README.md"
              echo "" >> "arxiv-trackers/README.md"
              echo "---" >> "arxiv-trackers/README.md"
              echo "" >> "arxiv-trackers/README.md"
            fi
          done

          cat >> "arxiv-trackers/README.md" << EOF

          ## ðŸš€ Quick Setup

          Run the setup workflow to configure a new tracker:
          1. Go to [Actions](../../actions)
          2. Select "Setup arXiv Paper Trackers"
          3. Fill in your research interests
          4. Follow the generated setup guide

          Or use the CLI:
          \`\`\`bash
          cd scripts/arxiv-automation
          ./setup-arxiv-tracker.sh
          \`\`\`

          EOF

      - name: Commit updates
        if: steps.check.outputs.has_trackers == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add synced-arxiv-papers/ arxiv-trackers/ 2>/dev/null || true

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“Š Daily sync: $(date +'%Y-%m-%d')

            Updated tracker status and sync information.

            ðŸ¤– Generated with GitHub Actions"

            git push
          fi

      - name: Create status issue
        if: steps.check.outputs.has_trackers == 'true' && github.event.inputs.create_summary == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const date = new Date().toISOString().split('T')[0];

            // Count configured trackers
            const configs = fs.readdirSync('arxiv-tracker-configs')
              .filter(f => f.endsWith('.yaml'));

            const trackerList = configs.map(f => {
              const name = f.replace('-config.yaml', '');
              return `- ${name}`;
            }).join('\n');

            const body = `# ðŸ“Š arXiv Tracker Status - ${date}

            ## Summary

            **Configured Trackers:** ${configs.length}
            **Status:** Configuration files created

            ## Your Trackers

            ${trackerList}

            ## ðŸ“‹ Status

            Your tracker configurations are saved in this repository. To start tracking papers:

            ### âœ… Completed
            - Configuration files generated
            - Setup guides created (check Issues with \`setup-guide\` label)

            ### ðŸ“ Next Steps

            For each tracker, you need to:
            1. **Fork the repository** (click link in setup guide issue)
            2. **Add your configuration** (download from this repo)
            3. **Enable GitHub Actions** in your fork
            4. **Papers tracked automatically** daily

            ## ðŸ”— Quick Links

            - [Tracker Configurations](https://github.com/${context.repo.owner}/${context.repo.repo}/tree/master/arxiv-tracker-configs)
            - [Tracker Status](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/master/arxiv-trackers/README.md)
            - [Setup Guides](https://github.com/${context.repo.owner}/${context.repo.repo}/issues?q=is%3Aissue+label%3Asetup-guide)
            - [Run Setup Workflow](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/workflows/setup-arxiv-trackers.yml)

            ## ðŸ’¡ Tips

            - **Multiple Trackers:** You can set up multiple trackers for different research areas
            - **CLI Option:** Use \`scripts/arxiv-automation/setup-arxiv-tracker.sh\` for automated setup
            - **Help:** Comment on setup guide issues if you need assistance

            ---

            *ðŸ¤– Auto-generated sync status*
            *Next check: ${new Date(Date.now() + 24*60*60*1000).toISOString().split('T')[0]}*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“Š Tracker Status Update - ${date}`,
              body: body,
              labels: ['arxiv-tracker', 'status-update', 'automated']
            });

      - name: No trackers message
        if: steps.check.outputs.has_trackers == 'false'
        run: |
          echo "âš ï¸  No tracker configurations found yet"
          echo ""
          echo "To get started:"
          echo "1. Go to Actions tab"
          echo "2. Run 'Setup arXiv Paper Trackers' workflow"
          echo "3. Configure your research interests"
          echo "4. Follow the generated setup guide"
          echo ""
          echo "Or use the CLI script:"
          echo "  cd scripts/arxiv-automation"
          echo "  ./setup-arxiv-tracker.sh"

      - name: Summary
        run: |
          echo "# ðŸ“Š Sync Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check.outputs.has_trackers }}" == "true" ]; then
            echo "âœ… **Tracker configurations found**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Configured trackers:" >> $GITHUB_STEP_SUMMARY
            for config in arxiv-tracker-configs/*.yaml; do
              if [ -f "$config" ]; then
                tracker=$(basename "$config" -config.yaml)
                echo "- $tracker" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "âš ï¸ **No trackers configured yet**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run the [Setup arXiv Paper Trackers](../../actions/workflows/setup-arxiv-trackers.yml) workflow to get started" >> $GITHUB_STEP_SUMMARY
          fi

  notify-completion:
    needs: sync-papers
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Send notification
        run: |
          echo "ðŸŽ‰ arXiv sync workflow completed!"
          echo "Status: ${{ needs.sync-papers.result }}"
          echo "Date: $(date +'%Y-%m-%d %H:%M:%S UTC')"
